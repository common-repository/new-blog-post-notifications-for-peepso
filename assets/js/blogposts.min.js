(function( $, peepso, factory ) {

	factory( $, peepso );

})( jQuery || $, peepso, function( $, peepso ) {


	function PsBlogposts()
	{
		this._fileList = [];
		// Tells the server the total size of all files on the queue, upload happens individually so we
		// need to know the total beforehand. For validation purposes
		this.queue_filesize = 0;
		this.$postbox = null;
		this.upload_started = false;
		this.can_submit = false;
		this.uploaded_data = {};
	}

	var ps_blogposts = peepso.blogposts = new PsBlogposts();

	/**
	 * TODO: docblock
	 */
	PsBlogposts.prototype.sortby = function(method) {
		this.load_blogposts_sort = method;
		this.load_blogposts_page = 1;
		this.load_blogposts_end = false;
		this.load_blogposts();
	};

	/**
	 * TODO: docblock
	 */
	PsBlogposts.prototype.load_blogposts = function() {
		var req = {
			'action': peepso_blogposts_data.action,
			'uid': peepsodata.currentuserid,
			'user_id': peepsodata.userid,
			'page': this.load_blogposts_page,
			'sort': this.load_blogposts_sort
		};


		if (this.load_blogposts_loading || this.load_blogposts_end) {

			if(this.load_blogposts_loading) console.log('ajax running');
			if(this.load_blogposts_end) console.log('items list finished');
			return;
		}

		this.load_blogposts_loading = true;
		console.log('ajax start');
		jQuery.post(peepso_blogposts_data.url, req, $.proxy(function(response) {

			if (response.success) {

				if (req.page <= 1) {
                    $(".ps-js-blogposts--" + peepsodata.userid).empty();
				}

                $(".ps-js-blogposts--" + peepsodata.userid).append( response.html );

				console.log('items remaining ' + response.found_blogposts);

				if (response.found_blogposts >= 1) {
					console.log('page +1');
					this.load_blogposts_page++;
				} else {
					console.log('items end');
					this.load_blogposts_end = true;
				}
			}

			console.log('ajax end');
			this.load_blogposts_loading = false;
		}, this));
	};

	/**
	 * TODO: docblock
	 */
	function isElementInViewport(el) {
		var rect = el.getBoundingClientRect();
		return (
			rect.top >= 0 &&
			rect.left >= 0 &&
			rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
			rect.right <= (window.innerWidth || document.documentElement.clientWidth)
		);
	}

	/**
	 * TODO: docblock
	 */
	PsBlogposts.prototype.autoscroll = function() {
		var eventName = "scroll.ps-blogposts",
			$trigger = $(".ps-js-blogposts-triggerscroll--" + peepsodata.userid),
			$win = $(window);

		if (!$trigger.length) {
			return;
		}
		$win.off(eventName).on(eventName, $.proxy(function() {
			if ( (!this.load_blogposts_end) && isElementInViewport( $trigger[0] ) ) {
				this.load_blogposts();
			}
		}, this ));
	};

	/**
	 * Performe page initialization on document ready action
	 */
	$(document).ready( function ()
	{

		var $sortby = $(".ps-js-blogposts-sortby--" + peepsodata.userid);
		if ($sortby.length) {
			ps_blogposts.sortby( $sortby.val() );
			ps_blogposts.autoscroll();
		}
	});
});
